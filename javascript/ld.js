function RDFGraph(){this.resources=[];this.triples=[];this.somenum=0;this.resources.find=function(c){for(var b=0,a=this.length;b<a;b++){if(this[b].resource==c){return b}}return -1};this.resources.add=function(a){return this.push({resource:a,triples:[]})};this.resources.len=function(){return this.length}}RDFGraph.prototype.clear=function(){this.triples.length=0;this.resources.length=0};RDFGraph.prototype.add=function(e,c,h,g,a){var b=true;var d=this.resources.find(e);if(d==-1){d=this.resources.add(e)-1}if(!g){if(c=="a"){c="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"}}var j={subject:d,predicate:c,object:h,object_literal_p:g,user:a};var f=this.triples.push(j)-1;this.resources[d].triples.push(f);this.tripleAdded(j);return b};RDFGraph.prototype.tripleAdded=function(a){return};RDFGraph.prototype.createBindings=function(c,b){var a={bindings:[{uri:this.resources[c.subject].resource},{uri:c.predicate},(c.object_literal_p)?{literal:c.object}:{uri:c.object},(b.setUserData)?{name:"user",uri:c.user}:{}]};if(b.pattern[0].charAt(0)=="?"){a.bindings[0].name=b.pattern[0].substring(1)}if(b.pattern[1].charAt(0)=="?"){a.bindings[1].name=b.pattern[1].substring(1)}if(b.pattern[2].charAt(0)=="?"){a.bindings[2].name=b.pattern[2].substring(1)}return a};RDFGraph.prototype.serialiseResult=function(c,b){var a={bindings:[{uri:this.resources[c.subject].resource},{uri:c.predicate},{},{}]};if(b.subject.charAt(0)=="?"){a.bindings[0].name=b.subject.substring(1)}if(b.predicate.charAt(0)=="?"){a.bindings[1].name=b.predicate.substring(1)}if(!c.object_literal_p){a.bindings[2].uri=c.object;if(b.objectUri.charAt(0)=="?"){a.bindings[2].name=b.objectUri.substring(1)}}else{a.bindings[2].literal=c.object;if(b.objectLiteral.charAt(0)=="?"){a.bindings[2].name=b.objectLiteral.substring(1)}}if(b.setContext){a.bindings[3].uri=c.user;a.bindings[3].name="context"}return a};RDFGraph.prototype.loadFormatters=function(c){var a=true;var e;var b=this.resources;var h=this.triples;for(var f=0,g=this.resources.length;f<g;f++){var n=b[f];for(var d=0;d<n.triples.length;d++){var l=h[n.triples[d]];if(l.predicate==="http://lib-xh.googlecode.com/include"||l.predicate==="http://www.w3.org/2002/07/owl#imports"){c.parseExternal(l.object)}}}return a};RDFGraph.prototype.createObject=function(c){var d=new myList();var e=this.triples;for(var b=0;b<c.triples.length;b++){var a=e[c.triples[b]];if(a.object_literal_p){d.add(a.predicate,a.object.content)}else{d.add(a.predicate,a.object)}}return d};function RDFStore(){this.graphs=[];this.bnode_counter=0}RDFStore.prototype.clear=function(){var a;for(a in this.graphs){this.graphs[a].clear()}return};RDFStore.prototype.getGraph=function(a){a=a||"default";if(!this.graphs[a]){this.graphs[a]=new RDFGraph(a)}return this.graphs[a]};RDFStore.prototype.add=function(b,a,e,g,f,d){var c=this.getGraph(b).add(a,e,g,f,d);this.tripleAdded(c);return c};RDFStore.prototype.tripleAdded=function(a){return};RDFStore.prototype.insert=function(h){var e,d,a,b,f,j,g,c;while(!h.length){if(h.graph){h=h.graph}else{h=[h]}}for(d=0;d<h.length;d++){j=h[d];e=j.name||"";if(j.pattern){f=h[d].pattern;this.add(e,f[0],f[1],f[2],f[3],null)}else{g=j["$"]||("bnode:dummy"+this.bnode_counter++);if((typeof(g)==="string")&&(g.indexOf("<")===0)&&(g.lastIndexOf(">")===g.length-1)){g=g.substring(1,g.length-1)}for(b in j){if(b!=="$"){c=j[b];if(b==="a"&&false){}if((typeof(c)==="string")&&(c.indexOf("<")===0)&&(c.lastIndexOf(">")===c.length-1)){a=true;c=c.substring(1,c.length-1)}else{a=(typeof(c)==="object")||(b==="http://xmlns.com/foaf/0.1/accountServiceHomepage")||(b==="http://lib-xh.googlecode.com/tooltip")||(b==="http://lib-xh.googlecode.com/icon")}this.add(e,g,b,(a)?((typeof c=="object")?this.insert(c,e):c):{content:c},!a,null)}}}}return g};RDFStore.prototype.createBindings=function(a,c,b){return this.getGraph(a).createBindings(c,b)};RDFStore.prototype.serialiseResult=function(a,c,b){return this.getGraph(a).serialiseResult(c,b)};RDFStore.prototype.loadFormatters=function(a,b){return this.getGraph(a).loadFormatters(b)};RDFStore.prototype.createObject=function(a,b){return this.getGraph(a).createObject(b)};function RDFQuery(a){this.store=a}RDFQuery.prototype.ask=function(b){var a=this.query2(b);return{head:{},"boolean":Boolean(a.results.bindings.length)}};RDFQuery.prototype.serialiseObject=function(e,b,a){var d=this.store.createObject("",b);var c=null;if(e.icon){var c=a.document.createElement("img");c.setAttribute("src",e.icon);a.appendChild(c)}if(e.tooltip){new YAHOO.widget.Tooltip("anon"+this.somenum++,{context:c?c:a,text:e.tooltip(d)})}return};RDFQuery.prototype.processObject=function(oAction,obj){var context=obj.user;if(context){var icon=null;if(oAction.icon){icon=context.document.createElement("img");icon.setAttribute("src",oAction.icon);context.appendChild(icon)}if(oAction.style){context.style.border=oAction.style.content}if(obj.icon){icon=context.document.createElement("img");icon.setAttribute("src",obj.icon);context.appendChild(icon)}if(oAction.tooltip){if(icon){new YAHOO.widget.Tooltip("anon"+this.somenum++,{context:icon,text:eval("'"+oAction.tooltip.content.replace(/\"/g,"'").replace(/\n/g,"").replace(/\$[\{\%7B]([^\}\%7D]*)[\}\%7D]/g,"' + obj.$1 + '")+"'")})}else{var el=context.document.createElement("span");el.innerHTML=eval("'"+oAction.tooltip.content.replace(/\n/g,"").replace(/\$[\{\%7B]([^\}\%7D]*)[\}\%7D]/g,"' + obj.$1 + '")+"'");context.appendChild(el)}}if(obj.tooltip&&icon){new YAHOO.widget.Tooltip("anon"+this.somenum++,{context:icon,text:eval("'"+obj.tooltip.content.replace(/\n/g,"").replace(/\$[\{\%7B]([^\}\%7D]*)[\}\%7D]/g,"' + obj.$1 + '")+"'")})}}if(oAction.action){oAction.action(obj)}if(obj.imp){var oParser=new RDFParser(this.store);oParser.parseExternal(obj.imp,oAction.onexternal)}return};RDFQuery.prototype.walk=function(n){var a=true;var g;var c=this.store.getGraph("").resources;for(var h=0,l=c.length;h<l;h++){var q=c[h];for(var d=0;d<q.triples.length;d++){var p=this.store.getGraph("").triples[q.triples[d]];if(n){if(!n.predicate||(p.predicate==n.predicate)){if(!n.object||(p.object==n.object)){if(n.pipesdata){var f=this;var e=n.pipesdata(q);var b=document.submissionJSON.run(e.url,e.params,{subject:q,context:p.user},function(r,j){if(n.adddata){n.adddata(e.url,r,j.subject)}f.serialiseObject(n,j.subject,j.context);return})}else{this.serialiseObject(n,q,p.user)}}}}}}return a};RDFQuery.prototype.walk2=function(c,f){var e=c.results.bindings;for(var b=0,a=e.length;b<a;b++){var d=e[b];this.processObject(f,d)}return};RDFQuery.prototype.query=function(l){var E={head:{vars:[]},results:{ordered:false,distinct:false,bindings:[]}};var G=this.store.getGraph("").resources;var u=this.store.getGraph("").triples;var v=[];for(var C=0;C<l.where.length;C++){var F=l.where[C];var a={pattern:F,triples:[]};for(var B=0,D=G.len();B<D;B++){var g=G[B];if(F.subject.charAt(0)=="?"||F.subject.charAt(0)=="$"||(F.subject==g.resource)){for(var A=0;A<g.triples.length;A++){var f=u[g.triples[A]];if((F.predicate.charAt(0)=="?"||F.predicate.charAt(0)=="$"||(F.predicate==f.predicate))&&(!(F.objectUri)||F.objectUri.charAt(0)=="?"||F.objectUri.charAt(0)=="$"||((F.objectUri==f.object)&&!f.object_literal_p))&&(!(F.objectLiteral)||F.objectLiteral.charAt(0)=="?"||F.objectLiteral.charAt(0)=="$"||((F.objectLiteral==f.object)&&f.object_literal_p))){a.triples.push(f)}}}}v.push(a)}var d=[];for(C=0;C<v.length;C++){var a=v[C];for(var B=0;B<a.triples.length;B++){var n=this.store.serialiseResult(a.graphURI,a.triples[B],a.pattern);var e=[];for(var A=0;A<4;A++){e[A]=(n.bindings[A].name)?{name:n.bindings[A].name,value:n.bindings[A].uri||n.bindings[A].literal}:null}if(!C){var c={matches:true,failed:false,values:[]};for(A=0;A<4;A++){if(e[A]){c.values[e[A].name]=e[A].value}}d.push(c)}else{for(A=0;A<d.length;A++){var p=d[A];if(p.failed){continue}var b=true;for(m=0;m<4;m++){if(e[m]&&p.values[e[m].name]&&(e[m].value!=p.values[e[m].name])){b=false;break}}if(b){for(m=0;m<4;m++){if(e[m]){p.values[e[m].name]=e[m].value}}p.matches=true}}}}for(A=0;A<d.length;A++){var n=d[A];if(n.matches||a.pattern.optional){n.matches=false}else{n.failed=true}}}for(C=0;C<d.length;C++){var n=d[C];var h={};if(!n.failed){for(var B=0;B<l.select.length;B++){var w=l.select[B].substring(1);h[w]=n.values[w]}h.context=n.values.context;E.results.bindings.push(h)}}return E};RDFQuery.prototype.query2=function(b){var p={head:{vars:[]},results:{ordered:false,distinct:(typeof b.distinct==="undefined")?true:Boolean(b.distinct),bindings:[]}};var u=[];var g=[];var c,n;var h,f,e,l;var a=0;this.addGraphs(b.from?b.from:"",b.where,g,u);if(u.length){this.mergeGraphs(g,u)}for(h=0;h<g.length;h++){var r=g[h];var t={};if(!r.failed){if(b.select&&(b.select[0]!="*")){for(var f=0;f<b.select.length;f++){var d=b.select[f];p.head.vars[f]=d;t[d]=r.values[d]}}else{for(f=0;f<r.values.length;f++){throw"Not sure about whether this correctly gets the name of property or key. (This will have been set with a 'select * where ...')";var d=r.values[f].name;p.head.vars[f]=d;t[d]=r.values[d]}}t.uuid=a++;t.user=r.values.user;p.results.bindings.push(t)}}if(p.results.bindings.length&&p.results.distinct){c=p.results.bindings;n=p.head.vars;for(h=0;h<c.length;h++){c[h]["uuid"]=h;for(f=h+1;f<c.length;f++){l=true;for(e=0;e<n.length;e++){varname=n[e];if(c[h][varname]!==c[f][varname]){l=false;break}}if(l){c.splice(f--,1)}}}}return p};RDFQuery.prototype.addGraphs=function(a,h,f,w){var b=this.store.getGraph(a).resources;var r=this.store.getGraph(a).triples;for(var g=0;g<h.length;g++){var n=h[g];if(n.where){if(w.length){this.mergeGraphs(f,w)}var e=[];var p=[];this.addGraphs(a,n.where,p,e);if(e.length){this.mergeGraphs(p,e);this.mergeResultSets(f,p,n.optional)}}else{if(n.pattern){if(n.pattern[1]=="a"){n.pattern[1]="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"}var q={graphURI:a,pattern:n,triples:[]};for(var d=0,l=b.length;d<l;d++){var v=b[d];if(n.pattern[0].charAt(0)=="?"||n.pattern[0].charAt(0)=="$"||(n.pattern[0]==v.resource)){for(var c=0;c<v.triples.length;c++){var u=r[v.triples[c]];if((n.pattern[1].charAt(0)=="?"||n.pattern[1].charAt(0)=="$"||(n.pattern[1]==u.predicate))&&(n.pattern[2].charAt(0)=="?"||n.pattern[2].charAt(0)=="$"||((n.pattern[2]==u.object)&&!u.object_literal_p)||((n.pattern[2]==u.object.content)&&u.object_literal_p))){q.triples.push(u)}}}}w.push(q)}}}return};RDFQuery.prototype.mergeGraphs=function(d,q){for(var e=0;e<q.length;e++){var h=q[e];for(var c=0;c<h.triples.length;c++){var n=this.store.createBindings(h.graphURI,h.triples[c],h.pattern);var l=[];for(var b=0;b<4;b++){l[b]=(n.bindings[b].name)?{name:n.bindings[b].name,value:n.bindings[b].uri||n.bindings[b].literal}:null}if(!e){var p={matches:true,failed:false,values:[]};for(b=0;b<4;b++){if(l[b]){p.values[l[b].name]=l[b].value}}d.push(p)}else{for(b=0;b<d.length;b++){var f=d[b];if(f.failed){continue}var g=true;for(var a=0;a<4;a++){if(l[a]&&f.values[l[a].name]&&(l[a].value!=f.values[l[a].name])){g=false;break}}if(g){for(a=0;a<4;a++){if(l[a]){f.values[l[a].name]=l[a].value}}f.matches=true}}}}for(b=0;b<d.length;b++){var l=d[b];if(l.matches||h.pattern.optional){l.matches=false}else{l.failed=true}}}q.length=0;return};RDFQuery.prototype.mergeResultSets=function(g,f,d){for(i=0;i<f.length;i++){var b=f[i];if(!b.failed){if(!g.length){g.push(b)}else{for(k=0;k<g.length;k++){var e=g[k];if(e.failed){continue}var h=true;for(var a in b.values){if(b.values[a]&&e.values[a]&&(b.values[a]!=e.values[a])){h=false;break}}if(h){for(a in b.values){if(b.values[a]){e.values[a]=b.values[a]}}e.matches=true}}}}for(k=0;k<g.length;k++){var c=g[k];if(c.matches||d){c.matches=false}else{c.failed=true}}}return g};function getPropertyFromVar(d,a,e){var c;var b=a.match(/\$(?:\{|%7B)(.*?)(?:\}|%7D)/);if(b){c=(d[b[1]])?((d[b[1]].content)?d[b[1]].content:d[b[1]]):((e)?"No value for '"+b[1]+"' ("+a+")":"")}else{c=(e)?"No key in '"+a+"'":""}return c}function execFuncWithObj(f,context,name){var expanded=f.replace(/\$(?:\{|\%7B)(.*?)(?:\}|\%7D)/g,function(m){return getPropertyFromVar(context.obj,m)});try{eval(expanded)}catch(e){throw"Failed to execute '"+name+"' ("+(e.message?e.message:e.description)+")"}return}function processFresnelSelectors(subj,obj){var s="?format";var g=(subj)?subj:"?group";var q;var classstyles=document.meta.query2({select:["t","cl","action","yowl","icon","tooltip","pipesdata","adddata","afterpipesdata"],where:[{pattern:[s,"a","http://www.w3.org/2004/09/fresnel#Format"]},{pattern:[s,"http://www.w3.org/2004/09/fresnel#group",g]},{pattern:[g,"a","http://www.w3.org/2004/09/fresnel#Group"]},{pattern:[s,"http://www.w3.org/2004/09/fresnel#classFormatDomain","?t"]},{pattern:[s,"http://www.w3.org/2004/09/fresnel#resourceStyle","?cl"],optional:true},{pattern:[s,"http://lib-xh.googlecode.com/action","?action"],optional:true},{pattern:[s,"http://lib-xh.googlecode.com/yowl","?yowl"],optional:true},{where:[{pattern:[s,"http://lib-xh.googlecode.com/tooltip","?tt"]},{pattern:["?tt","http://lib-xh.googlecode.com/icon","?icon"],optional:true},{pattern:["?tt","http://lib-xh.googlecode.com/template","?tooltip"]}],optional:true},{where:[{pattern:[s,"http://lib-xh.googlecode.com/pipesdata","?pipesdata"]},{pattern:[s,"http://lib-xh.googlecode.com/adddata","?adddata"]},{pattern:[s,"http://lib-xh.googlecode.com/afterpipesdata","?afterpipesdata"],optional:true}],optional:true}]});document.meta.walk2(classstyles,{action:function(classobj){var instances=document.meta.query2({select:["s"],where:[{pattern:["?s","a",classobj.t],setUserData:true}]});document.meta.walk2(instances,{action:function(instobj){processFresnelFormats(instobj.user,classobj);processLibXhFormats(instobj,classobj)}})}});classstyles=document.meta.query2({select:["p","cl"],where:[{pattern:[s,"a","http://www.w3.org/2004/09/fresnel#Format"]},{pattern:[s,"http://www.w3.org/2004/09/fresnel#propertyFormatDomain","?p"]},{pattern:[s,"http://www.w3.org/2004/09/fresnel#resourceStyle","?cl"]}]});document.meta.walk2(classstyles,{action:function(classobj){var results=document.meta.query2({select:["o"],where:[{pattern:["?s",classobj.p,"?o"],setUserData:true}]});document.meta.walk2(results,{action:function(instobj){processFresnelFormats(instobj.user,classobj)}})}});classstyles=document.meta.query2({select:["q","cl","action","yowl","embedInit","embedTemplate","embedTitle","icon","tooltip","pipesdata","adddata","afterpipesdata"],where:[{pattern:[s,"a","http://www.w3.org/2004/09/fresnel#Format"]},{pattern:[s,"http://www.w3.org/2004/09/fresnel#group",g]},{pattern:[g,"a","http://www.w3.org/2004/09/fresnel#Group"]},{pattern:[s,"http://www.w3.org/2004/09/fresnel#instanceFormatDomain","?q"]},{pattern:[s,"http://www.w3.org/2004/09/fresnel#resourceStyle","?cl"],optional:true},{pattern:[s,"http://lib-xh.googlecode.com/action","?action"],optional:true},{pattern:[s,"http://lib-xh.googlecode.com/yowl","?yowl"],optional:true},{where:[{pattern:[s,"http://lib-xh.googlecode.com/tooltip","?tt"]},{pattern:["?tt","http://lib-xh.googlecode.com/icon","?icon"],optional:true},{pattern:["?tt","http://lib-xh.googlecode.com/template","?tooltip"]}],optional:true},{where:[{pattern:[s,"http://lib-xh.googlecode.com/embed","?embed"]},{pattern:["?embed","http://lib-xh.googlecode.com/template","?embedTemplate"]},{pattern:["?embed","http://lib-xh.googlecode.com/init","?embedInit"],optional:true}],optional:true},{where:[{pattern:[s,"http://lib-xh.googlecode.com/pipesdata","?pipesdata"]},{pattern:[s,"http://lib-xh.googlecode.com/adddata","?adddata"]},{pattern:[s,"http://lib-xh.googlecode.com/afterpipesdata","?afterpipesdata"],optional:true}],optional:true}]});document.meta.walk2(classstyles,{action:function(classobj){try{q=classobj.q.content.replace(/\$(?:\{|\%7B)(.*?)(?:\}|\%7D)/g,function(m){return getPropertyFromVar(obj,m)})}catch(e){}var r=document.meta.query2(eval("({"+q+"})"));document.meta.walk2(r,{action:function(instobj){processFresnelFormats(instobj.user,classobj);processLibXhFormats(instobj,classobj)}})}});return}function processFresnelFormats(a,b){if(b.cl){YAHOO.util.Dom.addClass(a,b.cl.content)}return}function processLibXhFormats(obj,format){var context=obj.user;if(format.pipesdata){var pThis=this;eval("var rq = {"+format.pipesdata.content.replace(/[\n\r]/g,"").replace(/\"/g,"'").replace(/\$[\{\%7B]([^\}\%7D]*)[\}\%7D]/g,"obj.$1")+"};");var requestId=document.submissionJSON.run(rq.url,rq.params,obj,function(data,userData){if(format.adddata){execFuncWithObj(format.adddata.content,{data:data,obj:userData},"adddata")}if(format.afterpipesdata){processFresnelSelectors(format.afterpipesdata,userData)}return})}if(context){var icon=null;if(format.icon){icon=context.ownerDocument.createElement("img");icon.setAttribute("src",format.icon);context.appendChild(icon)}if(format.tooltip){var t;try{eval("t = '"+format.tooltip.content.replace(/\n/g,"").replace(/\'/g,"\\'").replace(/\$(?:\{|\%7B)(.*?)(?:\}|\%7D)/g,"' + obj.$1 + '")+"';")}catch(e){t="error: "+e.description}if(icon){new YAHOO.widget.Tooltip("anon"+this.somenum++,{context:icon,text:t})}else{var el=context.ownerDocument.createElement("span");el.innerHTML=t;context.appendChild(el)}}if(format.embedTemplate){var t;var el=context.ownerDocument.createElement("span");try{t=format.embedTemplate.content.replace(/\$(?:\{|\%7B)(.*?)(?:\}|\%7D)/g,function(m){return getPropertyFromVar(obj,m,true)})}catch(e){t="error: "+e.description}el.innerHTML=t;context.parentNode.insertBefore(el,context.nextSibling);if(format.embedInit){t=format.embedInit.content.replace(/\$(?:\{|\%7B)(.*?)(?:\}|\%7D)/g,function(m){return getPropertyFromVar(obj,m)});eval(t)}}}if(format.action){if(typeof(format.action.content)==="string"){eval(format.action.content.replace(/\$(?:\{|\%7B)(.*?)(?:\}|\%7D)/g,"obj.$1"))}else{if(typeof(format.action.content)==="function"){format.action.content.call(null,obj)}}}if(format.yowl){eval(format.yowl.content.replace(/\$(?:\{|\%7B)(.*?)(?:\}|\%7D)/g,"obj.$1"))}return}YAHOO.namespace("cc.ld");YAHOO.cc.ld.define_modules=function(a){var b="http://ubiquity-rdfa.googlecode.com/svn/tags/0.7.2/lib/";a.addModule({name:"ubiquity-backplane",type:"js",fullpath:"http://ubiquity-backplane.googlecode.com/svn/tags/0.4.5/backplane-loader.js"});a.addModule({name:"ubiquity-threads",type:"js",fullpath:b+"_backplane/threads.js"});a.addModule({name:"ubiquity-notify",type:"js",fullpath:"http://ubiquity-message.googlecode.com/svn/tags/0.5/lib/message-loader.js"});a.addModule({name:"ubiquity-rdfparser",type:"js",fullpath:b+"RDFParser.js",requires:["ubiquity-backplane"]});a.addModule({name:"ubiquity-rdfgraph",type:"js",fullpath:b+"RDFGraph.js"});a.addModule({name:"ubiquity-rdfstore",type:"js",fullpath:b+"RDFStore.js",requires:["ubiquity-rdfgraph"]});a.addModule({name:"ubiquity-rdfquery",type:"js",fullpath:b+"RDFQuery.js",requires:["dom","container","ubiquity-rdfstore"]})};YAHOO.cc.ld.request_success=function(a){if(a.status!=200){return}var b=YAHOO.lang.JSON.parse(a.responseText);store=new RDFStore();for(var e in b.subjects){s=b.subjects[e];for(var d in b.triples[s]){for(var c in b.triples[s][d]){o=b.triples[s][d][c];store.add(null,s,d,o,false,null)}}}a.argument.success(store)};YAHOO.cc.ld.request_failure=function(a){a.argument.failure(a.status)};YAHOO.cc.ld.load=function(b,a,c){var d={success:YAHOO.cc.ld.request_success,failure:YAHOO.cc.ld.request_failure,argument:c};YAHOO.util.Connect.initHeader("Referer",document.URL,true);var b=a+"?url="+encodeURIComponent(b);YAHOO.util.Connect.asyncRequest("GET",b,d,null)};YAHOO.cc.ld.finish_init=function(){YAHOO.register("cc.ld",YAHOO.cc.ld,{version:"0.1",build:"001"})};YAHOO.cc.ld.finish_init();